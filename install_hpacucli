Обновляем утилиту hpacucli

В этой статье мы рассмотрим как обновить или установить с нуля утилиту hpacucli, которая используется для настройки и диагностики контроллеров HP SmartArray в Linux.
Достаточно долгое время HP не обновляли эту утилиту и даже сложилось впечатление, что они полностью перестали ее поддерживать. Однако, не так давно мы обратили внимание, что по url, где размещалась старая версия этой утилиты, выдается ошибка 404, а у HP обновился портал Software Delivery Repository.
Чем же примечательна новая, 9я версия утилиты hpacucli? Во-первых, она перестала быть только 32 битной и появилась сборка под amd64. Во-вторых, утилита наконец узнала о существовании ядер linux 3.x, а значит для ее корректной работы больше не требуется использовать враппер uname26 (если вы не знаете что это и зачем, то вам повезло).
Итак, если у вас в распоряжении сервер HP ProLiant с установленным на нем Linux (Debian, Ubuntu, Oracle), то установить hpacucli можно так:
Шаг 1 скачиваем и запускаем скрипт add_repo.sh:
wget http://downloads.linux.hp.com/SDR/add_repo.sh
chmod +x ./add_repo.sh
./add_repo.sh mcp -r wheezy
В данном примере показан вариант запуска этого скрипта для Debian Wheezy. В результате, после того как вы согласитесь с условием лицензионного соглашения, скрипт сгенерирует файл /etc/apt/sources.list.d/HP-mcp.list следующего содержания:
# auto-generated by
# http://downloads.linux.hp.com/SDR/repo/./add_repo.sh mcp

# By including and using this configuration,
# you agree to the terms and conditions
# of the HP Software License Agreement at
# http://h20000.www2.hp.com/bizsupport/TechSupport/softwareLicense.jsp?lang=en&cc=us&prodTypeId=15351&prodSeriesId=1121516&prodNameId=3288134&taskId=135

# HP Software Delivery Repository for mcp
deb http://downloads.linux.hp.com/SDR/repo/mcp wheezy/current non-free
Шаг 2: устанавливаем пакет
apt-get update
apt-get install hpacucli
После установки пакета вы можете посмотреть состояние вашего контроллера и дисков, например:
# hpacucli ctrl all show config

Smart Array P420 in Slot 2

   array A (SAS, Unused Space: 0  MB)

      logicaldrive 1 (838.3 GB, RAID 1+0, OK)

      physicaldrive 2I:1:1 (port 2I:box 1:bay 1, SAS, 450 GB, OK)
      physicaldrive 2I:1:2 (port 2I:box 1:bay 2, SAS, 450 GB, OK)
      physicaldrive 2I:1:3 (port 2I:box 1:bay 3, SAS, 450 GB, OK)
      physicaldrive 2I:1:4 (port 2I:box 1:bay 4, SAS, 450 GB, OK)

   Enclosure SEP (Vendor ID HP, Model Gen8 ServBP 12+2) 378 (WWID: 5001438021F93D19, Port: 2I, Box: 1)
   Expander 380 (WWID: 5001438021F93D00, Port: 2I, Box: 1)
   SEP (Vendor ID PMCSIERA, Model SRCv8x6G) 379 (WWID: 5001438020D2331F)
А вот так можно посмотреть подробности настроек контроллера:
# hpacucli ctrl all show config detail

Smart Array P420 in Slot 2

   ...
   Controller Status: OK
   Hardware Revision: B
   Firmware Version: 2.14
   Rebuild Priority: Medium
   Expand Priority: Medium
   ...
   Cache Board Present: True
   Cache Status: OK
   Cache Ratio: 10% Read / 90% Write
   Drive Write Cache: Disabled
   Total Cache Size: 1024 MB
   ...
Здесь показана только часть отображаемых параметров. Например, интересным параметром является Cache Ratio. По-умолчанию, у вновь приобретенного контроллера Cache Ratio будет 100% Read / 0% Write. Для большинства случаев такая настройка не является оптимальной, ведь ваши диски наверняка используются не только для чтения. Если на диски в процессе работы производится активная запись, мы рекомендуем установить ratio в 25%/75% или даже увеличить процент для операций записи еще больше. Разница в производительности дискового массива при интенсивной записи при таком изменении настроек будет заметна невооруженным взглядом.
Для изменения Cache Ratio используйте команду hpacucli ctrl slot=2 modify cacheratio=25/75. Правильный номер слота вы можете увидеть в выводе команды hpacucli ctrl all show.
